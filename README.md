# General

Source code for the self-balancing-bike microcontroller unit (Teensy 4.1-based). 🚀️

## Files

Files:

* `controlModel.slx`: control model implementation in Simulink
* `gencode.m`: MATLAB function for code generation from Simulink model
* `params.sldd`: Simulink parameters used in `controlModel.slx`
* `build_linux.sh`: build shell script for Linux
* `build_win.bat`: build shell script for Windows
* `Doxyfile`: configuration file for documentation generation from source code using *doxygen*

Code folders:

* `./include`: contains `.h` files included in source code
* `./src`: contains source `.c` or `.cpp` files, including main file `main.cpp`
* `./lib`: contains a folder for each used library, with file `library.properties` for defining the library properties (mandatory for arduino compiling) and `.h` and `.cpp` files (possibly contained in folder `./src/`)
* `./hardware/teensy/avr/cores`: contains the core code for the Teensy microcontroller

Additional folders:

* `./hardware/teensy-windows`: build tools for Windows
* `./hardware/teensy-linux`: build tools for Linux
* `./docs/html`: contains the documentation in html (generated automatically from source code using *doxygen*)
* `./.vscode`: contains VS code property file(s)
* `./.build` and `.cache`: hidden folders created only during compilation

## Prerequisites

* *arduino-builder* (>=1.6.1), also provided with Arduino IDE
* *teeny_loader_cli* (>=2.2, Linux only), also provided with teensyduino. For Windows x64 pre-compiled binaries in `./hardware/teeny_loader_cli-win-x64` are used
* *MATLAB/Simulink* with *Embedeed Coder Toolbox* (>=2021a), for control algorithm code generation only

No other dependecies are necessary: all used libraries are already included in `./lib/`.

Additional utilities (only recommended):

* *teensyduino*: not stricktly necessary for compilation b/c core code for teensy MCU is already included in `./hardware/`
* *Visual Studio Code* with *C/C++ (ms-vscode)* for code completation and simpler code building

## Code generation

Code generation of the control algorithm is performed via *MATLAB/Simulink* with the *Embedeed Coder Toolbox*. Code generation can be launch with *MATLAB* using

```MATLAB
gencode()
```

By default `controlModel.slx` is used for code generation, with the parameters defined in `params.sldd`. Different Simulink model can be specified as an input in `gencode("...")`

## Building

Compilation is performed using the *arduino-builder*, while uploading using the *teensy_loader_cli*. Shell scripts provide simple usage depending on the operative system:

* Linux:

  ```bash
  ./build_linux.sh
  ```

  or

  ```bash
  bash build_linux.sh
  ```

  Tested with Arch-Linux x64. Sometimes it is necessary to delete manually the folders `.build` and `.cache`.
* Windows:

  ```batch
  ./build_win.bat
  ```

  Tested with Windows 10 x64.
* MacOS: not implemented yet

Alternatively, one can use `ctrl+shift+B` to build the code in *Visual Studio Code* with both Linux and Windows (this makes use of `build_linux.sh` or `build_win.sh` depending on the operative system).

## MTP mode

MTP mode allows to recognize the microcontroller as an MTP device (see e.g. [https://en.wikipedia.org/wiki/Media_Transfer_Protocol](https://en.wikipedia.org/wiki/Media_Transfer_Protocol)), in order to be capable of getting log files (with extension `*.sbb`) from the internal SD memory.
To enter in MTP mode, it is sufficient to keep the on/off button pressed for at least 3s when turning on. To get the MTP mode working in the PC side:

* Windows: no additional operation is usually necessary, the microcontroller should be automatically recognized as an MTP device
* Linux: install *gMTP* (from [https://gmtp.sourceforge.io/downloads.htmls](https://gmtp.sourceforge.io/downloads.htmls)), which is a MTP client for UNIX and UNIX like systems (this should include the *libmtp* library)

## Documentation

Documentation for the source code and the user-defined libraries (but not for other libraries found online) can be generated from the source using (see [https://www.doxygen.nl/download.html](https://www.doxygen.nl/download.html) for download) with

```shell
doxygen
```

Generated documentation includes only a html version (in `./docs/html`, main file is `index.html`). A latex documentation may be also generated by setting

```doxygen
GENERATE_LATEX  = YES
```

in `Doxyfile`. The latex version will be in `./docs/latex`) and can be compiled using latex with

```shell
cd ./docs/latex
make
```

which generates the pdf file `./doc/latex/refman.pdf`.

Documentation generation has been tested on Linux only, but it should work also in Windows.

## Known issues

* Uploading only possible by entering in program mode in Teensy MCU (press program button)
* Undefined identifiers found by Visual Studio Code, however this is only a C/C++ IntelliSense issue (compilation works fine)

## TODO list

* Doc:
  - How and where include .gencode.m in doc??????
* HW modification: use pin 36 instead of 34 for on/off button state, in order to make Serial8 available for SBUS
* Make using user-defined C functions in Simulink working when compiling
