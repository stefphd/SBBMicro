# Introduction

This repository contains the source code for the self-balancing-bike micro-controller unit (Teensy 4.1-based 🚀️).
The introduction shows the files and folders contained in this repository and how they are organized, the prerequisites necessary, and the procedures to be used in order to build and upload the code, to generate the documentation, and to automatically generate the control-algorithm code from the Simulink model (using matlab tools).

## Files

Files:

* `controlModel.slx`: control model implementation in Simulink
* `gencode.m`: MATLAB function for code generation from Simulink model
* `params.sldd`: Simulink parameters used in `controlModel.slx`
* `build_linux.sh`: build shell script for Linux
* `build_win.bat`: build shell script for Windows
* `Doxyfile`: configuration file for documentation generation from source code using *doxygen*
* `Makefile`: makefile for building, uploading and documentation generation using *make*

Code folders:

* `./include`: contains `.h` files included in source code
* `./src`: contains source `.c` or `.cpp` files, including main file `main.cpp`
* `./lib`: contains a folder for each used library, with file `library.properties` for defining the library properties (mandatory for arduino compiling) and `.h` and `.cpp` files (possibly contained in folder `./src/`)
* `./hardware/teensy/avr/cores`: contains the core code for the Teensy microcontroller

Additional folders:

* `./hardware/teensy-windows`: build tools for Windows
* `./hardware/teensy-linux`: build tools for Linux
* `./docs/html`: contains the documentation in html (generated automatically from source code using *doxygen*)
* `./docs/extra`: contains extra documentation (user-written), which is included using *doxygen*
* `./matlab-tools`: contains matlab tools usefull for code generation and other stuff
* `./.vscode`: contains VS code property file(s)
* `./.build` and `.cache`: hidden folders created only during compilation

## Prerequisites

* *arduino-builder* (>=1.6.1), also provided with Arduino IDE
* *MATLAB/Simulink* with the *Embedeed Coder Toolbox* installed (>=2021a), for control algorithm code generation only

No other dependecies are necessary: all used libraries are already included in `./lib/`.

Additional utilities (only recommended):

* *teensyduino*: not stricktly necessary for compilation b/c core code for teensy MCU is already included in `./hardware/`
* *Visual Studio Code* with *C/C++ (ms-vscode)* for code completation and simpler code building
* *make* to build using the `Makefile`

## Documentation

Documentation for the source code and the user-defined libraries (but not for other third-party libraries) can be generated from the source using (see [https://www.doxygen.nl/download.html](https://www.doxygen.nl/download.html) for download) with

```shell
doxygen
```

or using *make*

```shell
make doc
```

Generated documentation includes only a html version in `./docs/html`, with main file `index.html`. Documentation is also available on <https://stefphd.github.io/SBBMicro/>.
A latex documentation may be also generated by setting

```doxygen
GENERATE_LATEX  = YES
```

in `Doxyfile`. The latex version will be in `./docs/latex`, and can be compiled using latex with

```shell
cd ./docs/latex
make
```

which generates the pdf file `./doc/latex/refman.pdf`.

\attention Latex documentation requires having both *latex* and *make* installed.

## Code generation

Code generation of the control algorithm is performed via *MATLAB/Simulink* with the *Embedeed Coder Toolbox*. Other toolboxes may be required. Code generation can be launch with *MATLAB* using

```MATLAB
addpath('./matlab-tools');
gencode()
```

The general usage of this function is

```MATLAB
addpath('./matlab-tools');
gencode(modelname,dest_dir);
```

where `modelname` is the name of the Simulink model (without the `*.slx` extension included), while `dest_dir` is the destination directory: generated code is placed in `./dest_dir/modelname/src`. If no modelname is given, the function uses the first `*.slx` file found in the current directory. If no destination directory is given, the functions uses `./lib`. Code generation may be also performed using *make*, however this may take some time.

\note Toolboxes required by the code generation can be shown by running in MATLAB

  ```MATLAB
  addpath('./matlab-tools');
  check_toolboxes();
  ```

\attention For a correct usage in this project the above functions should be run in the main directory, and not in `./matlab-tools/`.

## Building

Compilation is performed using the *arduino-builder*. Shell scripts provide simple usage depending on the operative system:

* Linux:

  ```shell
  ./build_linux.sh
  ```

  or

  ```shell
  bash build_linux.sh
  ```

  \note Tested with Arch-Linux x64.

* Windows:

  ```shell
  ./build_win.bat
  ```

  \note Tested with Windows 10 x64.

* MacOS: not implemented yet, however it should be similar to Linux.

Alternatively, one can use `ctrl+shift+B` to build the code in *Visual Studio Code* with both Linux and Windows (this makes use of `build_linux.sh` or `build_win.sh` depending on the operative system).

\note The above shell scripts perform both the building and the uploading: it is not possible to build or upload only.

## Make tools

One may also use *make* for the building, uploading and the documentation generation. This allows several operations using similar syntax, so as to perform single operations at a time:

* `make` or `make all` to build and upload the code.
* `make build` to build the code only
* `make upload` to upload code only
* `make clean` to clean the build and cache directories
* `make remake` to clean, build and upload the code
* `make rebuild` to clean and rebuild
* `make gencode` to generate the code from the Simulink model
  \note This may take some time.
  \attention This requires (at least) MATLAB/Simulink >= 2022a with the Embedeed code installed

* `make checktoolboxes` to check the MATLAB toolboxes required by the code generation
* `make doc` to build the documentation
* `make cleandoc` to clean the documentation
* `make help` to print the Makefile help

\note The above commands can be also used at the same time, e.g. `make build doc` to build and generate the documentation.

## Known issues

* Undefined identifiers found by Visual Studio Code, however this is only a C/C++ IntelliSense issue (compilation works fine)

\todo Doc: Documentaton for Simuling and code generation???
\todo Make user-defined C functions in Simulink working when compiling
\todo To implement brake motor
